# ファイル名: btc_jpy_price_blockchain_api.rb

require 'net/http'
require 'json'

# ------------------------------------------------------------
# (2) ビットコインの現在の市場価格（円換算）を取得するコード
# ------------------------------------------------------------
# ■問題文の要請
#   「ビットコインの現在の市場価格（円換算）を調べよ」
#
#   ここでは、集中取引所やOTC市場などをすべて厳密に統合した
#   “理想的な理論価格”ではなく、
#   Blockchain.com が提供している公開APIのティッカー情報
#   （直近の取引価格 = last price）を
#   「市場価格の代表値」として扱う。
#
# ■理論的な意味づけ
#   - 金融市場で「市場価格」と言うとき、
#     典型的には「直近の約定価格」や「板の中間値(mid price)」などを指す。
#   - Blockchain.com の tickers API では、
#     通貨ペアごとに "last" というフィールドを持っており、
#     これは「直近約定価格（最後に取引された価格）」を表す。
#   - よって、この "last" を取得することで、
#     その瞬間の BTC/JPY の代表的な市場価格を近似的に得ることができる。
#
#   ※実際の市場では、取引所ごとの価格差（アービトラージ）や
#     スプレッドなどが存在するため、
#     あくまで「一つの取引所の代表値」である点には注意。

# ------------------------------------------------------------
# 1. Blockchain.com の tickers API から JSON を取得
# ------------------------------------------------------------
# エンドポイント:
#   https://blockchain.info/tickers
#
# 応答のイメージ（簡略化）:
# {
#   "BTC": {
#     "JPY": {
#       "15m":  価格(15分平均),
#       "last": 直近約定価格,
#       "buy":  買い気配,
#       "sell": 売り気配,
#       "symbol": "¥"
#     },
#     "USD": { ... },
#     ...
#   },
#   ...
# }
#
# ここでは、「BTC を JPY で評価したときの直近約定価格」
# = BTC/JPY の「市場価格」的な値を取り出す。
uri = URI.parse('https://blockchain.info/tickers')

# Net::HTTP.get は、指定した URI から HTTP GET を行い、
# レスポンスボディを文字列として返す。
response_body = Net::HTTP.get(uri)

# API応答は JSON 形式の文字列なので、
# JSON.parse で Ruby のハッシュに変換する。
# gsub("\n",'') は、万一改行が含まれていても問題なくパースできるようにするための保険。
btc_tickers = JSON.parse(response_body.gsub("\n", ''))

# ------------------------------------------------------------
# 2. BTC/JPY の直近約定価格 "last" を取り出す
# ------------------------------------------------------------
# JSON 構造から見ると、
#   - 最初の "BTC" は「ビットコインに関するティッカー集合」
#   - その中の "JPY" は「BTC/JPY ペア」
#   - さらに "last" が直近約定価格
#
# したがって、btc_tickers["BTC"]["JPY"]["last"] が
# 「現在の BTC/JPY の代表的な市場価格（直近値）」となる。
btc_jpy_last = btc_tickers["BTC"]["JPY"]["last"]

# ------------------------------------------------------------
# 3. 結果の出力
# ------------------------------------------------------------
puts "現在の BTC/JPY 直近約定価格 (last): #{btc_jpy_last} 円"

# ------------------------------------------------------------
# 4. 補足：2021年7月2日時点の値について
# ------------------------------------------------------------
# 問題文中のコメント：
#   「2021年７月２日時点で　3676342.41円」
#
# これは、2021-07-02 時点で同じ API を叩いたときの
# btc_jpy_last が約 3,676,342.41 円だった、という記録と解釈できる。
#
# このコード自体は「実行した時点のリアルタイム価格」を取得するものであり、
# 過去（2021-07-02）の価格を再現するものではない。
# 履歴データを再現したい場合は、
#   - 過去日時の価格を保存しておく
#   - ヒストリカルな価格 API（過去データ用エンドポイント）を利用する
# といった別の仕組みが必要になる。