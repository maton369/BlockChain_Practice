# ファイル名: current_block_reward.rb

require 'time'

# ------------------------------------------------------------
# (1) ビットコインのブロック報酬を現在時点から計算するコード
# ------------------------------------------------------------
# 問題文：
# 「ジェネシスブロックのタイムスタンプは 2009-01-04 03:15:05 +0900。
#  1ブロックの生成速度を平均10分として，現在の1ブロックあたりの
#  マイニング報酬を求めよ。」
#
# ビットコインでは
#   - 初期報酬: 1ブロック 50 BTC
#   - 210,000 ブロックごとに報酬が半減（halving）
# というルールになっている。
#
# 「平均10分で1ブロック生成される」とすると、
#   210,000 ブロック × 10分 = 2,100,000 分
#   = 2,100,000 × 60 秒 = 126,000,000 秒
# がおおよそ「1回の半減期に相当する時間」になる。
#
# ジェネシスから現在までに何回この半減期が経過したかを数え、
#   報酬 = 50 * (1/2)^（半減回数）
# という式で現在のブロック報酬を求める。

# ------------------------------------------------------------
# 1. ジェネシスブロックのタイムスタンプ（JST）
# ------------------------------------------------------------
genesis_time = Time.new(2009, 1, 4, 3, 15, 5, '+09:00')

# ------------------------------------------------------------
# 2. 「現在時刻」の設定
# ------------------------------------------------------------
# 問題文のコメントにある通り、
#   「2021年7月2日時点で 6.25 BTC」
# となることを確認したいので、
# ここでは「現在時刻」を 2021-07-02 00:00:00 JST に固定する。
#
# 実際に「いまこの瞬間の報酬」を計算したい場合は、
#   now_time = Time.now
# のように Time.now を使えば良い。
now_time = Time.new(2021, 7, 2, 0, 0, 0, '+09:00')
# now_time = Time.now  # 実際の現在時刻で計算したいときはこの行を使う

# ------------------------------------------------------------
# 3. パラメータ設定
# ------------------------------------------------------------

# 初期報酬（ジェネシス時点の1ブロックあたり報酬）
initial_reward_btc = 50.0   # BTC

# 1ブロックあたりの平均生成時間（秒）
block_interval_sec = 600    # 10分 = 600秒

# 何ブロックごとに報酬が半減するか
halving_interval_blocks = 210_000

# 1回の半減期に相当する時間（秒）
halving_period_sec = block_interval_sec * halving_interval_blocks
# = 600 * 210000 = 126,000,000 秒（約 4 年）

# ------------------------------------------------------------
# 4. 経過時間から「半減回数」を求める
# ------------------------------------------------------------

# ジェネシスから現在までに経過した時間（秒）
elapsed_sec = now_time - genesis_time

# 経過時間を「半減期」によって割り、
# 何回分の半減期が経過したか（実数）を求める。
# 例: 2.3 回分なら「2回半減が起きている」とみなすので floor を取る。
halving_count = (elapsed_sec / halving_period_sec).floor

# ------------------------------------------------------------
# 5. 現在のブロック報酬を計算
# ------------------------------------------------------------
# ビットコインの報酬スケジュール：
#   報酬_n = 初期報酬 * (1/2)^n
# ここで n は「半減回数」。
current_reward_btc = initial_reward_btc * (0.5 ** halving_count)

# ------------------------------------------------------------
# 6. 結果の出力
# ------------------------------------------------------------

puts "ジェネシスブロック時刻: #{genesis_time} (JST)"
puts "現在時刻:                #{now_time} (JST)"
puts "経過時間(秒):            #{elapsed_sec.to_i}"
puts "半減期(秒):              #{halving_period_sec}"
puts "半減回数:                #{halving_count} 回"
puts "現在の1ブロックあたり報酬: #{current_reward_btc} BTC"

# ------------------------------------------------------------
# 7. 問題文の1行コードとの対応
# ------------------------------------------------------------
# 問題文で示されていた1行版は以下の通りである：
#
#   reward = 50 * (0.5 ** (
#     (Time.now - Time.new(2009,1,4,3,15,5,'+09:00')) / (600*210000)
#   ).floor)
#
# このコードと上の実装は理論的に同じことをしている：
#   - Time.now を now_time に置き換えた
#   - 各値を変数に分解して、何を意味するかをコメントで明示した
#
# 2021年7月2日時点で実行すると、
#   半減回数 halving_count = 3
#   現在の報酬 = 50 * (1/2)^3 = 6.25 BTC
# となり、問題文の「2021年７月２日時点で 6.25 BTC」と一致する。