# ファイル名: hash_chain_with_function.rb

require 'digest'

# ------------------------------------------------------------
# ハッシュチェーン（Hash Chain）の実装と利用例
# ------------------------------------------------------------
# ■コンセプト
# ハッシュチェーンは「前の要素のハッシュ値」を次の要素に取り込むことで、
# 一連のデータ列を鎖状に結びつける仕組み。
#
# 具体的には、各ブロックを
#   block = "<自分のデータ>:<直前ブロックのハッシュ値>"
# のように構成し、それに対して SHA-256 を適用する。
#
# これにより：
# - 途中の任意のデータが改ざんされると、
# - その後ろの全てのハッシュ値が変化し、
# - 最後のハッシュ値（チェーンの「まとめ」）も変わってしまう。
#
# つまり、「末尾のハッシュ値」を監視するだけで、
# 途中の履歴が改ざんされていないかを検出できる構造になっている。
#
# ブロックチェーンも同様に、「直前ブロックのハッシュ」を
# 各ブロックヘッダに含めることで同様の改ざん検出機構を実現している。

# ------------------------------------------------------------
# 初期値（IV: Initial Value）とデータ列
# ------------------------------------------------------------
# IV (Initial Vector / Initial Value) はチェーンの最初の「ひもづけ先」となる値。
# 本来は固定して合意された値や、別に定義された「ジェネシスブロックのハッシュ」等を使う。
IV = "0000"

# データの配列（本来はトランザクション集合などが入る想定）
data_list = ["0001", "0002", "0003", "0004"]

# ------------------------------------------------------------
# ハッシュチェーン生成関数
# ------------------------------------------------------------
# data_list: データの配列
# prev_hash: 直前ブロックのハッシュ値（最初は IV を渡す）
#
# 戻り値:
#   ["data1:prev_hash_or_IV", "data2:hash(block1)", ...] という形式の配列
#
# 理論的な意味:
# - 各 block = data + ":" + prev_hash は、
#   「現在のデータ」と「これまでの履歴のまとめ（prev_hash）」を結びつけたもの。
# - それに SHA-256 をかけて得られるハッシュ値が、次のブロックの前提情報となることで、
#   チェーン全体が一体となって改ざん検出に寄与する。
def hashchain(data_list, prev_hash)
  data_list.map do |data|
    # 現在のブロックの内容を「データ:直前ハッシュ」で表現
    block = data + ':' + prev_hash
    # 次のループのために prev_hash を更新
    prev_hash = Digest::SHA256.hexdigest(block)
    # ブロックそのもの（文字列）を返す
    block
  end
end

# ------------------------------------------------------------
# ハッシュチェーンの生成と結果確認
# ------------------------------------------------------------
blockchain = hashchain(data_list, IV)

# チェーンの内容（各ブロック）を出力
puts "# ハッシュチェーン（各ブロックの内容）"
puts blockchain
# 期待される出力例:
# [
#  "0001:0000",
#  "0002:5114fae697241bc0cf0d914d637ee368919ef2d4bc49302289141c71a00ec6b2",
#  "0003:b1d7dfe29aeaaba6fadaceffce8d6709e4c5cdfa80ce7673b62d4dcc66fcea2e",
#  "0004:43371bcb864782ec393fa830eae758ad1e2b172989e8763074fa7a576a8cfe55"
# ]

# チェーンの最終ハッシュ値（最後のブロックに対する SHA-256）
# これはチェーン全体に対する「コミットメント（要約）」として解釈できる。
lasthash = Digest::SHA256.hexdigest(blockchain[-1])

puts
puts "# 最終ハッシュ値（チェーン全体へのコミットメント）"
puts lasthash
# 期待される出力例:
# 9455075057982b2d43c6fcaa9e5e75058efd43a21107f67526515face5c48365

# ------------------------------------------------------------
# 理論的な補足
# ------------------------------------------------------------
# ■なぜ「最後のハッシュ値」が重要か
# - 各ブロックが「直前ブロックのハッシュ」を参照するため、
#   block1, block2, block3, block4 のいずれかのデータを書き換えると、
#   その場所以降のハッシュ値がすべて変わる。
# - 結果として、最終的な lasthash も変わってしまう。
# - 逆に言えば、lasthash が期待された値のままであれば、
#   途中の履歴が改ざんされていないとみなせる（ハッシュの衝突が起きていないという前提のもと）。
#
# ■ブロックチェーンとの関係
# - 実際のブロックチェーンでは、各ブロックが
#   「前ブロックのハッシュ + 自ブロックのメタ情報 + トランザクション群」などをまとめてハッシュ化している。
# - このサンプルは、構造を極端に単純化した「一次元のブロックチェーン」として、
#   改ざん耐性の本質（ハッシュによる履歴の連結）を示している。